<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <title>Comunidad Davar - Red Ministerial</title>
  
  <!-- Sello de Identidad Permanente (Azul, Blanco y Dorado) -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%231877F2%22%20rx%3D%2240%22%2F%3E%3Ctext%20x%3D%22100%22%20y%3D%22115%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-weight%3D%22900%22%20font-size%3D%2285%22%20fill%3D%22white%22%20text-anchor%3D%22middle%22%20letter-spacing%3D%22-4%22%3ECD%3C%2Ftext%3E%3Ctext%20x%3D%22100%22%20y%3D%22160%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-weight%3D%22900%22%20font-size%3D%2226%22%20fill%3D%22%23D4AF37%22%20text-anchor%3D%22middle%22%20text-transform%3D%22uppercase%22%20letter-spacing%3D%222%22%3EDios%3C%2Ftext%3E%3C%2Fsvg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%231877F2%22%20rx%3D%2240%22%2F%3E%3Ctext%20x%3D%22100%22%20y%3D%22115%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-weight%3D%22900%22%20font-size%3D%2285%22%20fill%3D%22white%22%20text-anchor%3D%22middle%22%20letter-spacing%3D%22-4%22%3ECD%3C%2Ftext%3E%3Ctext%20x%3D%22100%22%20y%3D%22160%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-weight%3D%22900%22%20font-size%3D%2226%22%20fill%3D%22%23D4AF37%22%20text-anchor%3D%22middle%22%20text-transform%3D%22uppercase%22%20letter-spacing%3D%222%22%3EDios%3C%2Ftext%3E%3C%2Fsvg%3E">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v10 Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <style>
    :root { --fb-blue: #1877F2; --fb-bg: #F0F2F5; --fb-white: #FFFFFF; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--fb-bg); margin: 0; color: #1C1E21; overflow: hidden; height: 100vh; }
    
    .header-fb { background: var(--fb-white); height: 56px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; width: 100%; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-bottom: 1px solid #e4e6eb; flex-shrink: 0; }
    
    .card-fb { background: var(--fb-white); border-radius: 12px; border: 1px solid #dddfe2; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 12px; overflow: hidden; position: relative; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #bcc0c4; border-radius: 10px; }
    
    .nav-active { background-color: #E7F3FF; color: var(--fb-blue); font-weight: 900; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    /* ESTILOS DEL VIVO Y CHAT INTEGRADO */
    .live-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; }
    .btn-circle-mini { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer; border: 3px solid rgba(255,255,255,0.2); }
    .btn-circle-mini:active { transform: scale(0.9); }
    
    .live-chat-overlay { position: absolute; bottom: 80px; left: 15px; width: calc(100% - 90px); max-height: 40vh; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; z-index: 1020; scroll-behavior: smooth; }
    .live-chat-msg { background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 12px; color: white; font-size: 13px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); width: fit-content; word-break: break-word; }
    .live-chat-input-area { position: absolute; bottom: 15px; left: 15px; width: calc(100% - 90px); z-index: 1020; display: flex; gap: 8px; }
    
    .nav-bottom { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #e4e6eb; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #65676B; transition: 0.2s; border: none; background: none; outline: none; padding: 6px 0; cursor: pointer; height: 100%; }
    .nav-btn.active { color: var(--fb-blue); }
    .nav-btn i { font-size: 20px; margin-bottom: 2px; }
    .nav-btn span { font-size: 8.5px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.2px; white-space: nowrap; margin-top: 3px; }

    .animate-up { animation: slideUp 0.3s ease-out forwards; }
    @keyframes slideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* ESTILOS DE REACCIONES (CON PUNTOS ROJOS) */
    .reac-btn { font-size: 13px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; font-weight: bold; color: #65676B; cursor: pointer; border: none; background: none; padding: 6px 8px; border-radius: 6px; flex: 1; }
    .reac-btn:hover { background: #F2F2F2; }
    .reac-btn.active-amen { color: #D4AF37; }
    .reac-btn.active-bendice { color: #E41E3F; }
    .reac-badge { position: absolute; top: -8px; right: -16px; background-color: #E41E3F; color: white; font-size: 10px; font-weight: 900; padding: 2px 5px; border-radius: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); line-height: 1; z-index: 10; min-width: 20px; text-align: center; }
    .reactions-mini { display: flex; gap: 6px; padding: 4px; width: fit-content; margin-top: 4px; }
    
    .profile-cover { width: 100%; height: 180px; background: #E4E6EB; border-radius: 12px 12px 0 0; object-fit: cover; }
    .profile-avatar-wrapper { margin-top: -60px; position: relative; display: inline-block; }
    .comment-bubble { background: #F0F2F5; padding: 8px 12px; border-radius: 18px; font-size: 13px; margin-bottom: 4px; border: 1px solid #dddfe2; }
    
    .emoji-panel { display: grid; grid-template-cols: repeat(6, 1fr); gap: 8px; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 12px; position: absolute; z-index: 100; bottom: 70px; left: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 260px; max-height: 150px; overflow-y: auto; }
    .emoji-item { font-size: 22px; cursor: pointer; text-align: center; padding: 4px; transition: transform 0.1s; }
    .emoji-item:active { transform: scale(1.3); }

    @media (max-width: 640px) {
      .header-fb { padding: 0 10px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDquU86YIWcujUgTLwoJPZcrxRBjNGLkz4", 
      authDomain: "project-a972c4a3-b179-439a-9a5.firebaseapp.com",
      projectId: "project-a972c4a3-b179-439a-9a5",
      storageBucket: "project-a972c4a3-b179-439a-9a5.firebasestorage.app",
      appId: "1:501639945234:web:e72c02f89beb3b86540ccb"
    };

    let auth = null;
    let db = null;
    const isInvalidKey = !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("PEGUE") || firebaseConfig.apiKey === "";

    if (!isInvalidKey) {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        db.settings({ experimentalForceLongPolling: true });
    }
    
    const appId = "comunidad-davar-v2026-arca-final"; 
    
    // LOGOS Y PORTADAS
    const LOGO_URL = "data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%231877F2%22%20rx%3D%2240%22%2F%3E%3Ctext%20x%3D%22100%22%20y%3D%22115%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-weight%3D%22900%22%20font-size%3D%2285%22%20fill%3D%22white%22%20text-anchor%3D%22middle%22%20letter-spacing%3D%22-4%22%3ECD%3C%2Ftext%3E%3Ctext%20x%3D%22100%22%20y%3D%22160%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-weight%3D%22900%22%20font-size%3D%2226%22%20fill%3D%22%23D4AF37%22%20text-anchor%3D%22middle%22%20text-transform%3D%22uppercase%22%20letter-spacing%3D%222%22%3EDios%3C%2Ftext%3E%3C%2Fsvg%3E";
    const DEFAULT_COVER = "data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%221000%22%20height%3D%22400%22%3E%3Crect%20width%3D%221000%22%20height%3D%22400%22%20fill%3D%22%23E4E6EB%22%2F%3E%3Cpath%20d%3D%22M0%20400%20L1000%20400%20L1000%20200%20Q500%20350%200%20200%20Z%22%20fill%3D%22%231877F2%22%20opacity%3D%220.1%22%2F%3E%3C%2Fsvg%3E";

    function GuestBanner() {
        return (
            <div className="bg-red-600 text-white text-center py-2 px-4 text-[10px] font-black uppercase tracking-widest shadow-md flex-shrink-0 z-50">
                ‚è≥ MODO VISITANTE: Ingrese a "Perfil" para participar plenamente.
            </div>
        );
    }

    const compressMedia = (file) => new Promise((resolve) => {
      if (!file) return resolve('');
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (e) => {
        if (file.type.startsWith('image/')) {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_SIZE = 800; 
            let w = img.width, h = img.height;
            if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } }
            else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
            
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, w, h);
            
            let dataUrl = canvas.toDataURL('image/webp', 0.65);
            if (dataUrl.indexOf('data:image/webp') !== 0) {
                dataUrl = canvas.toDataURL('image/jpeg', 0.65);
            }
            resolve(dataUrl); 
          };
        } else { resolve(e.target.result); }
      };
    });

    const MediaProjector = ({ url }) => {
      if (!url) return null;
      if (url.startsWith('data:image') || url.match(/\.(jpeg|jpg|gif|png|webp)$/)) {
        return <div className="mt-2 bg-[#f0f2f5] rounded-lg overflow-hidden flex justify-center border border-gray-200 shadow-sm"><img src={url} className="max-h-96 object-contain w-full" alt="Imagen Ministerial" onError={(e)=>{e.target.onerror = null; e.target.src=LOGO_URL;}} /></div>;
      }
      return <a href={url} target="_blank" rel="noopener noreferrer" className="p-3 bg-blue-50 rounded-xl border border-blue-100 block text-blue-600 font-bold truncate text-[11px] mb-2"><i className="fa-solid fa-link mr-2"></i> Abrir contenido externo</a>;
    };

    // --- SESI√ìN EN VIVO DIRECTA Y SIN BOT√ìN VERDE ---
    const LiveSession = ({ profile, broadcasterId, isBroadcaster, onClose }) => {
      const roomName = `DavarMinisterio_${broadcasterId}`;
      const [chatMsgs, setChatMsgs] = useState([]);
      const [newMsg, setNewMsg] = useState('');
      const chatEndRef = useRef(null);

      let liveCol = db ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lives') : null;
      let chatCol = db ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('live_chats').doc(broadcasterId).collection('messages') : null;

      // EL MILAGRO: Al montar este componente, se abre Jitsi y se registra en la nube inmediatamente
      useEffect(() => {
        if (isBroadcaster && liveCol) {
          liveCol.doc(broadcasterId).set({ 
             uid: broadcasterId, 
             name: profile?.name || "Visitante", 
             photo: profile?.photo || LOGO_URL, 
             at: Date.now() 
          });
        }
        
        let unsubChat = () => {};
        if (chatCol) {
            unsubChat = chatCol.orderBy('at', 'asc').limitToLast(40).onSnapshot(s => {
                setChatMsgs(s.docs.map(d => ({id: d.id, ...d.data()})));
            });
        }

        return () => {
            unsubChat();
            if (isBroadcaster && liveCol) {
                liveCol.doc(broadcasterId).delete();
            }
        };
      }, []);

      useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMsgs]);

      const stopStream = async () => {
         if (isBroadcaster && liveCol) await liveCol.doc(broadcasterId).delete();
         onClose();
      };

      const sendMsg = () => {
          if(!newMsg.trim() || !chatCol) return;
          chatCol.add({
              uid: profile?.uid || 'anonimo',
              authorName: profile?.name || 'Visitante',
              text: newMsg.trim(),
              at: Date.now()
          });
          setNewMsg('');
      };

      // Motor ultraligero
      const jitsiUrl = `https://meet.jit.si/${roomName}#config.startWithAudioMuted=false&config.startWithVideoMuted=false&config.disableDeepLinking=true&config.prejoinPageEnabled=false&config.resolution=360&config.videoQuality.maxBitratesVideo=500&config.disableVideoBackground=true&config.startBitrate=400&config.disableAudioLevels=true&config.disableSimulcast=true`;

      return (
        <div className="live-overlay animate-in z-[6000]">
          <div className="flex-1 bg-black relative flex flex-col items-center justify-center overflow-hidden">

            {/* TRANSMISI√ìN EN VIVO REAL (JITSI ABRE DE INMEDIATO) */}
            <iframe src={jitsiUrl} className="absolute inset-0 w-full h-full border-none z-10" allow="camera; microphone; fullscreen; display-capture; autoplay" />

            {/* ENCABEZADO DURANTE EL VIVO */}
            <div className="absolute top-10 left-6 flex items-center gap-3 bg-black/80 p-2 pr-5 rounded-full backdrop-blur-md border border-white/20 shadow-lg z-20">
               <img src={profile?.photo || LOGO_URL} className="h-10 w-10 rounded-full border-2 border-[#1877F2] object-cover bg-white" onError={(e)=>{e.target.src=LOGO_URL}} />
               <div>
                  <p className="text-white font-black text-xs uppercase leading-none">{profile?.name || "Visitante"}</p>
                  <p className="text-red-500 text-[9px] font-black mt-1 animate-pulse">‚óè EN VIVO</p>
               </div>
            </div>
            
            {/* CHAT EN VIVO TRANSPARENTE */}
            <div className="live-chat-overlay no-scrollbar z-20">
                {chatMsgs.map(m => (
                    <div key={m.id} className="live-chat-msg">
                        <span className="font-black text-[#1877F2] opacity-90">{m.authorName}: </span>
                        <span className="font-medium text-white">{m.text}</span>
                    </div>
                ))}
                <div ref={chatEndRef} />
            </div>
            
            {/* CAJA DE TEXTO DEL CHAT */}
            <div className="live-chat-input-area z-20">
                <input type="text" value={newMsg} onChange={e=>setNewMsg(e.target.value)} onKeyDown={e=>e.key==='Enter'&&sendMsg()} placeholder="Escriba un am√©n..." className="flex-1 bg-black/60 text-white placeholder-gray-300 px-5 py-3 rounded-full outline-none border border-white/20 backdrop-blur-md text-[16px] shadow-lg" />
                <button onClick={sendMsg} className="w-12 h-12 bg-[#1877F2] text-white rounded-full flex items-center justify-center active:scale-90 transition-transform shadow-lg border border-blue-400 shrink-0">
                    <i className="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            {/* BOT√ìN ROJO PARA FINALIZAR EL VIVO */}
            <div className="absolute right-4 bottom-[80px] z-20 flex flex-col gap-4">
              {isBroadcaster ? (
                  <button onClick={stopStream} className="btn-circle-mini bg-red-600 text-white shadow-2xl animate-pulse ring-4 ring-red-600/30" title="Finalizar Transmisi√≥n">
                      <i className="fa-solid fa-phone-slash text-2xl"></i>
                  </button>
              ) : (
                  <button onClick={stopStream} className="btn-circle-mini bg-gray-200 text-gray-800 shadow-xl" title="Salir de la transmisi√≥n">
                      <i className="fa-solid fa-xmark text-2xl"></i>
                  </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    function WallView({ user, profile, isUnlocked, isAdmin, onStartLive, onJoinLive }) {
      const [posts, setPosts] = useState([]); const [lives, setLives] = useState([]);
      const [txt, setTxt] = useState(''); const [img, setImg] = useState(''); const [audio, setAudio] = useState('');
      const [location, setLocation] = useState(''); const [tag, setTag] = useState('');
      const [loading, setLoading] = useState(false); const [sysMsg, setSysMsg] = useState('');
      const [linkInputOpen, setLinkInputOpen] = useState(false); const [linkUrl, setLinkUrl] = useState('');
      const [showEmoji, setShowEmoji] = useState(false);
      
      const [isPostDialogOpen, setIsPostDialogOpen] = useState(false);
      const [audioState, setAudioState] = useState('idle'); 
      const [recordingTime, setRecordingTime] = useState(0);
      const mrRef = useRef(null); 
      const audioChunks = useRef([]); 
      const timerRef = useRef(null);
      
      let postCol;
      if (db) {
        postCol = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts');
      }

      useEffect(() => {
        if(!user || !db || !postCol) return;
        const u1 = postCol.onSnapshot(s => setPosts(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>b.at-a.at)), err => console.log("Muro Error"));
        const u2 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lives').onSnapshot(s => setLives(s.docs.map(d=>({id:d.id, ...d.data()}))), err => console.log("Vivos Error"));
        return () => { u1(); u2(); };
      }, [user]);

      const requireAuth = (action) => {
          if (!profile || !isUnlocked) {
              setSysMsg("‚ö†Ô∏è Acci√≥n bloqueada: Ingrese en la pesta√±a 'PERFIL' con su clave para participar.");
              setTimeout(() => setSysMsg(''), 5000);
          } else {
              action();
          }
      };

      const startVoice = async () => {
        setIsPostDialogOpen(true);
        setSysMsg('');
        setAudioState('requesting');
        
        try {
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
              throw new Error("El navegador no soporta grabaci√≥n.");
          }

          const s = await navigator.mediaDevices.getUserMedia({ audio: true });
          const mr = new MediaRecorder(s); 
          mrRef.current = mr; 
          audioChunks.current = [];
          
          mr.ondataavailable = e => { if (e.data && e.data.size > 0) audioChunks.current.push(e.data); };
          
          mr.onstop = () => { 
            clearInterval(timerRef.current);
            const audioType = mr.mimeType || 'audio/webm';
            const b = new Blob(audioChunks.current, { type: audioType }); 
            const r = new FileReader(); 
            r.readAsDataURL(b); 
            r.onloadend = () => {
                setAudio(r.result);
                setAudioState('recorded');
            }; 
            s.getTracks().forEach(t => t.stop()); 
            setRecordingTime(0);
          };
          
          mr.start(500); 
          setAudioState('recording'); 
          
          timerRef.current = setInterval(() => {
              setRecordingTime(t => { 
                  if(t >= 179) { 
                      if (mrRef.current && mrRef.current.state !== 'inactive') mrRef.current.stop(); 
                      return 180; 
                  } 
                  return t+1; 
              });
          }, 1000);
          
        } catch(e) { 
            console.error(e);
            setAudioState('idle');
            setSysMsg("‚ö†Ô∏è Por favor, permita el acceso al micr√≥fono en su celular para grabar."); 
        }
      };

      const cancelAudio = () => {
          clearInterval(timerRef.current);
          setRecordingTime(0);
          if (mrRef.current) {
              mrRef.current.onstop = null; 
              if (mrRef.current.state !== 'inactive') mrRef.current.stop();
              if (mrRef.current.stream) mrRef.current.stream.getTracks().forEach(t => t.stop());
          }
          setAudio('');
          setAudioState('idle');
      };

      const closeDialog = () => {
          cancelAudio();
          setTxt('');
          setImg('');
          setLinkUrl('');
          setLocation('');
          setTag('');
          setLinkInputOpen(false);
          setIsPostDialogOpen(false);
      };

      const sendPost = async () => {
        if(loading || (!txt.trim() && !img && !audio && !linkUrl && !location && !tag) || !postCol) return;
        setLoading(true); setSysMsg('');
        
        let finalTxt = txt;
        if (location) finalTxt += `\nüìç En: ${location}`;
        if (tag) finalTxt += `\nüë§ Con: ${tag}`;
        if (linkUrl) finalTxt += `\nüîó ${linkUrl}`;

        try { 
          await postCol.add({ uid:user.uid, authorName:profile.name, authorPhoto:profile.photo || LOGO_URL, text:finalTxt, img, audio:audio, at:Date.now(), reactions:{} });
          closeDialog();
        } catch(e) { setSysMsg("Error al subir bendici√≥n. Intente de nuevo."); }
        setLoading(false);
      };

      return (
        <div className="space-y-4 pb-24 animate-up text-left w-full max-w-[620px] mx-auto mt-2">
          {lives.map(l => (
            <div key={l.id} className="bg-red-500 p-3 rounded-xl flex items-center justify-between text-white shadow-lg animate-pulse mx-2 sm:mx-0">
              <div className="flex items-center gap-3"><img src={l.photo || LOGO_URL} onError={(e)=>{e.target.src=LOGO_URL}} className="h-9 w-9 rounded-full border-2 border-white object-cover shadow-sm bg-white" /><p className="font-bold text-[11px] uppercase italic">‚óè EN VIVO: {l.name}</p></div>
              <button onClick={()=>onJoinLive(l.uid)} className="bg-white text-red-600 px-5 py-1.5 rounded-full font-black text-[10px] uppercase shadow-sm active:scale-95 transition-all leading-none">UNIRSE</button>
            </div>
          ))}

          {sysMsg && <div className="bg-red-50 text-red-600 p-4 rounded-xl text-center text-[11px] font-black shadow-inner border border-red-100 mx-2 sm:mx-0">{sysMsg}</div>}

          <div className="card-fb p-4 shadow-sm bg-white mx-2 sm:mx-0">
              <div className="flex gap-3 mb-3">
                <img src={profile?.photo || LOGO_URL} onError={(e)=>{e.target.src=LOGO_URL}} className="h-10 w-10 rounded-full object-cover border border-gray-200 shadow-sm bg-gray-50 flex-shrink-0" />
                <div onClick={()=> requireAuth(() => setIsPostDialogOpen(true))} className="w-full bg-gray-100 rounded-full p-2.5 px-5 text-gray-500 text-[14px] cursor-pointer hover:bg-gray-200 italic flex items-center shadow-inner leading-none truncate">¬øQu√© inspiraci√≥n tiene hoy?</div>
              </div>
              <div className="flex gap-1 border-t border-gray-100 pt-2">
                <div onClick={() => requireAuth(onStartLive)} className="flex-1 flex items-center justify-center gap-2 p-2 rounded-lg cursor-pointer text-red-500 font-black hover:bg-gray-50 active:scale-95 transition-transform"><i className="fa-solid fa-circle-play text-xl"></i><span className="text-[11px]">VIVO</span></div>
                <label className="flex-1 flex items-center justify-center gap-2 p-2 rounded-lg cursor-pointer text-green-600 font-black hover:bg-gray-50 active:scale-95 transition-transform" onClick={(e) => { if(!profile || !isUnlocked) { e.preventDefault(); requireAuth(()=>{}); } }}>
                  <i className="fa-solid fa-camera text-xl"></i><span className="text-[11px]">FOTO</span>
                  <input type="file" className="hidden" accept="image/*" onChange={async e=>{ if(profile && isUnlocked) { setImg(await compressMedia(e.target.files[0])); setIsPostDialogOpen(true); } }} />
                </label>
                <div onClick={() => requireAuth(startVoice)} className="flex-1 flex items-center justify-center gap-2 p-2 rounded-lg cursor-pointer text-orange-500 font-black hover:bg-gray-50 active:scale-95 transition-transform"><i className="fa-solid fa-microphone-lines text-xl"></i><span className="text-[11px]">VOZ</span></div>
              </div>
          </div>
          
          {isPostDialogOpen && (
          <div className="card-fb p-5 border-2 border-[#1877F2] animate-in shadow-2xl relative bg-white z-50 mb-4 mx-2 sm:mx-0">
             <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-2"><h3 className="font-bold text-gray-800 text-[12px] uppercase italic">Nueva Bendici√≥n</h3><i onClick={closeDialog} className="fa-solid fa-xmark cursor-pointer p-2 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-200"></i></div>
             
             {audioState === 'requesting' && (
                <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl mb-4 text-center shadow-inner w-full">
                   <p className="text-orange-600 font-bold animate-pulse text-sm">Conectando micr√≥fono...</p>
                </div>
             )}

             {(audioState === 'recording' || audioState === 'paused') && (
                <div className="bg-red-50 border border-red-100 p-4 rounded-xl mb-4 text-center shadow-inner w-full">
                   <div className="flex flex-col items-center gap-3">
                      <div className="text-red-600 font-black text-2xl font-mono leading-none mb-1">
                         <span className={audioState === 'recording' ? 'animate-pulse' : ''}>üî¥</span> {recordingTime}s <span className="text-sm text-red-400">/ 180s</span>
                      </div>
                      <div className="flex items-center justify-center gap-6">
                        {audioState === 'recording' ? (
                           <button onClick={()=> {if(mrRef.current && mrRef.current.state === 'recording') { mrRef.current.pause(); setAudioState('paused'); clearInterval(timerRef.current); }}} className="bg-yellow-500 text-white w-14 h-14 rounded-full shadow-lg hover:scale-105 transition-transform" title="Pausar"><i className="fa-solid fa-pause text-xl"></i></button>
                        ) : (
                           <button onClick={()=> {if(mrRef.current && mrRef.current.state === 'paused') { mrRef.current.resume(); setAudioState('recording'); timerRef.current = setInterval(()=>setRecordingTime(t=>t+1), 1000); }}} className="bg-green-500 text-white w-14 h-14 rounded-full shadow-lg hover:scale-105 transition-transform" title="Continuar"><i className="fa-solid fa-play text-xl ml-1"></i></button>
                        )}
                        <button onClick={()=> {if(mrRef.current && mrRef.current.state !== 'inactive') mrRef.current.stop(); }} className="bg-red-600 text-white w-14 h-14 rounded-full shadow-lg hover:scale-105 transition-transform" title="Terminar y Guardar"><i className="fa-solid fa-stop text-xl"></i></button>
                        <button onClick={cancelAudio} className="bg-gray-400 text-white w-10 h-10 rounded-full shadow-md hover:scale-105 transition-transform" title="Borrar Audio"><i className="fa-solid fa-trash"></i></button>
                      </div>
                   </div>
                </div>
             )}
             
             {audioState === 'recorded' && audio && (
                <div className="mt-2 bg-blue-50 p-3 rounded-xl border border-blue-100 shadow-sm flex items-center gap-2 mb-3">
                    <audio src={audio} controls className="h-10 flex-1" />
                    <i onClick={cancelAudio} className="fa-solid fa-trash text-red-500 p-2 cursor-pointer bg-white rounded-full shadow-sm hover:scale-110" title="Eliminar Audio"></i>
                </div>
             )}

             <textarea value={txt} onChange={e=>setTxt(e.target.value)} placeholder={`Escriba su mensaje aqu√≠...`} className="w-full h-24 outline-none text-[16px] resize-none placeholder-gray-400 p-3 rounded-xl bg-gray-50 border border-gray-100 shadow-inner text-gray-800" />
             {img && <div className="mt-2 relative inline-block"><img src={img} className="h-32 object-cover rounded-lg shadow-md border-2 border-white" /><i onClick={()=>setImg('')} className="fa-solid fa-circle-xmark absolute -top-2 -right-2 text-gray-800 cursor-pointer bg-white rounded-full text-xl shadow-lg"></i></div>}
             
             {location && <div className="mt-2 text-xs font-bold text-gray-600 bg-gray-100 px-3 py-1 rounded-full inline-block">üìç Ubicaci√≥n: {location} <i className="fa-solid fa-xmark ml-2 cursor-pointer text-red-500" onClick={()=>setLocation('')}></i></div>}
             {tag && <div className="mt-2 ml-2 text-xs font-bold text-gray-600 bg-gray-100 px-3 py-1 rounded-full inline-block">üë§ Con: {tag} <i className="fa-solid fa-xmark ml-2 cursor-pointer text-red-500" onClick={()=>setTag('')}></i></div>}
             
             {linkInputOpen && (
                <div className="flex gap-2 mt-3 bg-blue-50 p-2 rounded-xl border border-blue-100 w-full mb-3 shadow-inner">
                   <input type="text" value={linkUrl} onChange={e=>setLinkUrl(e.target.value)} placeholder="Pegue el enlace aqu√≠" className="flex-1 bg-transparent text-gray-800 text-[16px] outline-none px-2 font-bold" />
                   <button onClick={(e)=>{ e.preventDefault(); setLinkInputOpen(false); }} className="bg-[#1877F2] text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase shadow-md">Listo</button>
                </div>
             )}

             <div className="border border-gray-100 rounded-xl p-3 my-3 flex items-center justify-between bg-gray-50 relative shadow-sm">
                <i onClick={() => setShowEmoji(!showEmoji)} className="fa-regular fa-face-smile text-yellow-500 text-xl cursor-pointer active:scale-90 bg-white p-2 rounded-lg shadow-sm" title="Emojis"></i>
                {showEmoji && <div className="emoji-panel custom-scrollbar shadow-2xl">{['üôè','‚ù§Ô∏è','üôå','üî•','üåü','üìñ','üïäÔ∏è','‚õ™','üíé','üåà','üåç','üìú','‚ú®','üé∫','üí™','ü§ù','üçû','üç∑','üëë','üõ°Ô∏è','‚ö°','üåø','‚úÖ'].map(e=>(<span key={e} onClick={()=>{setTxt(p=>p+e); setShowEmoji(false);}} className="emoji-item">{e}</span>))}</div>}
                
                <i onClick={()=>setLinkInputOpen(!linkInputOpen)} className="fa-solid fa-link text-[#1877F2] text-xl cursor-pointer active:scale-90 bg-white p-2 rounded-lg shadow-sm" title="Agregar Enlace"></i>
                <i onClick={()=>{const loc = prompt("¬øD√≥nde se encuentra?"); if(loc) setLocation(loc);}} className="fa-solid fa-location-dot text-red-500 text-xl cursor-pointer active:scale-90 bg-white p-2 rounded-lg shadow-sm" title="Agregar Ubicaci√≥n"></i>
                <i onClick={()=>{const t = prompt("¬øA qui√©n desea etiquetar?"); if(t) setTag(t);}} className="fa-solid fa-user-tag text-green-600 text-xl cursor-pointer active:scale-90 bg-white p-2 rounded-lg shadow-sm" title="Etiquetar Hermano"></i>
             </div>
             
             <button onClick={sendPost} disabled={loading || (audioState !== 'idle' && audioState !== 'recorded')} className="w-full bg-[#1877F2] text-white font-black py-4 rounded-xl shadow-md active:scale-95 text-[13px] uppercase tracking-widest transition-all disabled:opacity-50">
                 {loading ? 'Subiendo...' : 'Compartir Bendici√≥n'}
             </button>
          </div>
          )}

          {posts.length === 0 && (
             <div className="text-center p-10 opacity-40">
                <i className="fa-solid fa-scroll text-5xl mb-4 text-gray-400"></i>
                <p className="font-black uppercase tracking-widest text-xs text-gray-500">El Muro est√° esperando su bendici√≥n.</p>
             </div>
          )}

          {posts.map(p => (
            <div key={p.id} className="card-fb animate-up border border-gray-200 shadow-sm bg-white relative mx-2 sm:mx-0">
              {(p.uid === user?.uid || isAdmin) && <button onClick={()=>{ postCol.doc(p.id).delete(); }} className="absolute top-3 right-3 text-gray-400 hover:text-red-500 transition-colors z-10 p-2"><i className="fa-solid fa-trash-can"></i></button>}
              <div className="p-4 flex gap-3 pr-8 text-left"><img src={p.authorPhoto || LOGO_URL} onError={(e)=>{e.target.src=LOGO_URL}} className="h-10 w-10 rounded-full object-cover border border-gray-200 shadow-sm bg-gray-50 flex-shrink-0" /><div><p className="font-bold text-[13px] leading-none mb-1 text-[#1877F2] uppercase tracking-tighter">{p.authorName}</p><p className="text-[9px] text-gray-400 font-black uppercase tracking-widest leading-none">{new Date(p.at).toLocaleString()}</p></div></div>
              {p.text && <p className="px-5 pb-3 text-[15px] leading-relaxed text-gray-800 whitespace-pre-wrap">{p.text}</p>}
              <MediaProjector url={p.img} />
              {p.audio && <div className="px-4 py-3 bg-gray-50 border-y border-gray-100 shadow-inner"><audio src={p.audio} controls className="w-full h-10" /></div>}
              <div className="reac-bar border-t border-gray-100 pt-1 flex px-2 gap-2 bg-gray-50/50 pb-1">
                <button disabled={!profile || !isUnlocked} onClick={async()=>{
                    if(!postCol) return;
                    const rs = { ...(p.reactions || {}) };
                    if (rs[user?.uid] === 'amen') delete rs[user?.uid]; else rs[user?.uid] = 'amen';
                    await postCol.doc(p.id).update({ reactions: rs });
                }} className={`reac-btn ${p.reactions?.[user?.uid]==='amen'?'active-amen':''}`}>
                    <div className="relative flex items-center justify-center gap-2 px-2">
                        <i className="fa-solid fa-hands-praying text-xl"></i> <span className="text-[12px] font-black uppercase">Am√©n</span>
                        {Object.values(p.reactions||{}).filter(r=>r==='amen').length > 0 && (
                            <span className="reac-badge">{Object.values(p.reactions||{}).filter(r=>r==='amen').length}</span>
                        )}
                    </div>
                </button>
                <button disabled={!profile || !isUnlocked} onClick={async()=>{
                    if(!postCol) return;
                    const rs = { ...(p.reactions || {}) };
                    if (rs[user?.uid] === 'bendice') delete rs[user?.uid]; else rs[user?.uid] = 'bendice';
                    await postCol.doc(p.id).update({ reactions: rs });
                }} className={`reac-btn ${p.reactions?.[user?.uid]==='bendice'?'active-bendice':''}`}>
                    <div className="relative flex items-center justify-center gap-2 px-2">
                        <i className="fa-solid fa-heart text-xl"></i> <span className="text-[12px] font-black uppercase">Bendice</span>
                        {Object.values(p.reactions||{}).filter(r=>r==='bendice').length > 0 && (
                            <span className="reac-badge">{Object.values(p.reactions||{}).filter(r=>r==='bendice').length}</span>
                        )}
                    </div>
                </button>
              </div>
            </div>
          ))}
        </div>
      );
    }

    function ChatPanel({ user, profile, isUnlocked, isAdmin }) {
      if (!user) return null;
      const [msgs, setMsgs] = useState([]); const [txt, setTxt] = useState('');
      let col;
      if (db) {
         col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chat');
      }
      const endRef = useRef(null);
      useEffect(() => { 
        if (!user || !col) return;
        const unsub = col.onSnapshot(s => setMsgs(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>a.at-b.at).slice(-60)), err => console.log("Chat Error")); 
        return ()=>unsub(); 
      }, [user]);
      useEffect(() => { endRef.current?.scrollIntoView({behavior:'smooth'}); }, [msgs]);
      const send = async () => { if(!txt.trim() || !profile || !isUnlocked || !col) return; await col.add({uid:user.uid, name:profile.name, text:txt.trim(), photo:profile.photo || LOGO_URL, at:Date.now()}); setTxt(''); };
      
      return (
        <div className="flex flex-col card-fb overflow-hidden animate-up bg-white border-t-4 border-[#1877F2] shadow-2xl mx-2 sm:mx-auto max-w-[650px] mt-2" style={{ height: 'calc(100vh - 160px)' }}>
          <div className="p-3 border-b text-center font-black text-gray-500 text-[10px] uppercase bg-gray-50 shadow-sm italic tracking-widest leading-none">Chat Ministerial</div>
          <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50/50 custom-scrollbar">
            {msgs.length === 0 && <div className="text-center mt-10 opacity-40"><i className="fa-solid fa-comments text-4xl mb-2 text-gray-400"></i><p className="text-[10px] font-black uppercase text-gray-500">Sin mensajes a√∫n.</p></div>}
            {msgs.map((m,i)=>(
              <div key={m.id} className={`flex gap-2 relative group ${m.uid===user?.uid?'flex-row-reverse':''}`}>
                <img src={m.photo || LOGO_URL} onError={(e)=>{e.target.src=LOGO_URL}} className="h-8 w-8 rounded-full object-cover border border-gray-200 shadow-sm bg-white" />
                <div className={`p-3 rounded-2xl text-[13px] max-w-[80%] shadow-sm ${m.uid===user?.uid?'bg-[#1877F2] text-white font-medium':'bg-white text-gray-800 border border-gray-100'}`}>
                   {m.uid !== user?.uid && <p className="text-[8px] font-black text-gray-400 mb-1 uppercase leading-none">{m.name}</p>}
                   {m.text}
                </div>
                {isAdmin && <button onClick={()=>col.doc(m.id).delete()} className="text-red-400 px-2 active:scale-90"><i className="fa-solid fa-trash-can text-xs"></i></button>}
              </div>
            ))}
            <div ref={endRef} />
          </div>
          <div className="p-3 bg-white flex gap-2 border-t shadow-inner shrink-0">
            {(!profile || !isUnlocked) ? <div className="w-full text-center text-[11px] text-red-500 font-black p-3 bg-red-50 rounded-xl border border-red-100">INGRESE A PERFIL PARA CHATEAR</div> : 
              <><input type="text" value={txt} onChange={e=>setTxt(e.target.value)} placeholder="Escriba aqu√≠..." className="flex-1 bg-gray-100 rounded-full px-5 text-[16px] outline-none border border-gray-200 shadow-inner text-gray-800" onKeyDown={e=>e.key==='Enter'&&send()} /><button onClick={send} className="w-12 h-12 shrink-0 rounded-full bg-[#1877F2] text-white flex items-center justify-center active:scale-90 shadow-md transition-transform"><i className="fa-solid fa-paper-plane text-lg"></i></button></>
            }
          </div>
        </div>
      );
    }

    // --- FORMULARIOS BLINDADOS (SIEMPRE VISIBLES, PROTEGIDOS CON AVISO) ---

    function WisdomView({ user, profile, isUnlocked, isAdmin }) {
      const [items, setItems] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [title, setTitle] = useState('');
      const [content, setContent] = useState('');
      const [sysMsg, setSysMsg] = useState('');

      useEffect(() => { 
          if(!db) return;
          const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wisdom').onSnapshot(s => setItems(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>b.at-a.at)), err => console.log(err)); 
          return ()=>unsub(); 
      }, []);

      const handleToggle = () => {
          if (!profile || !isUnlocked) {
              setSysMsg("‚ö†Ô∏è Acci√≥n bloqueada: Ingrese a 'Perfil' con su PIN para publicar.");
              setTimeout(() => setSysMsg(''), 5000);
          } else {
              setShowForm(!showForm);
          }
      };

      const handleAdd = async () => {
          if(!title.trim() || !content.trim() || !user || !profile) return;
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wisdom').add({
              title, content, uid: user.uid, authorName: profile.name, at: Date.now()
          });
          setShowForm(false); setTitle(''); setContent('');
      };

      return (
        <div className="space-y-6 pb-24 max-w-[650px] mx-auto px-4 mt-4 animate-in">
          <div className="card-fb p-6 bg-gradient-to-br from-[#1877F2]/10 to-white border-t-4 border-[#1877F2] shadow-xl text-center">
            <i className="fa-solid fa-sparkles text-3xl text-[#1877F2] mb-3"></i>
            <h2 className="font-black text-xl text-gray-800 uppercase tracking-tighter italic">Sabidur√≠a Ministerial</h2>
          </div>

          {sysMsg && <div className="bg-red-50 text-red-600 p-4 rounded-xl text-center text-[11px] font-black shadow-inner border border-red-100 mb-4">{sysMsg}</div>}

          <div className="mb-4">
             <button onClick={handleToggle} className="w-full bg-white border-2 border-[#1877F2] text-[#1877F2] font-black py-4 rounded-xl shadow-sm uppercase text-[12px] active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i className={`fa-solid ${showForm ? 'fa-xmark text-red-500' : 'fa-plus'}`}></i> {showForm ? 'Cancelar' : 'Compartir Sabidur√≠a'}
             </button>
             {showForm && (
                <div className="mt-3 card-fb p-5 animate-in shadow-lg border border-gray-200">
                   <input placeholder="Tema o T√≠tulo..." value={title} onChange={e=>setTitle(e.target.value)} className="w-full bg-gray-50 border border-gray-200 p-4 rounded-xl mb-3 outline-none font-bold text-gray-800 text-[16px]" />
                   <textarea placeholder="Escriba la palabra de sabidur√≠a..." value={content} onChange={e=>setContent(e.target.value)} className="w-full bg-gray-50 border border-gray-200 p-4 rounded-xl mb-4 outline-none h-32 resize-none text-gray-800 text-[16px]" />
                   <button onClick={handleAdd} className="w-full bg-[#1877F2] text-white font-black py-4 rounded-xl shadow-md uppercase text-[12px] active:scale-95 transition-transform">Publicar Semilla</button>
                </div>
             )}
          </div>

          {items.length === 0 && (
             <div className="text-center p-10 opacity-40">
                 <i className="fa-solid fa-seedling text-5xl mb-4 text-gray-400"></i>
                <p className="font-black uppercase tracking-widest text-xs text-gray-500">Esperando la primera semilla.</p>
             </div>
          )}
          {items.map(d => (
            <div key={d.id} className="card-fb p-6 bg-white border border-gray-200 shadow-md animate-up text-left relative">
              {(isAdmin || d.uid === user?.uid) && <button onClick={()=>db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wisdom').doc(d.id).delete()} className="absolute top-4 right-4 text-red-400 active:scale-90"><i className="fa-solid fa-trash-can"></i></button>}
              <h3 className="font-black text-lg text-[#1877F2] mb-2 italic uppercase pr-6">{d.title}</h3>
              <p className="text-gray-700 text-[15px] leading-relaxed mb-4 whitespace-pre-wrap">{d.content}</p>
              <div className="flex justify-between items-center border-t border-gray-100 pt-3">
                 <span className="text-[10px] text-gray-500 font-bold uppercase"><i className="fa-solid fa-user text-[#1877F2] mr-1"></i> {d.authorName}</span>
                 <span className="text-[9px] text-gray-400 font-bold uppercase italic">{new Date(d.at).toLocaleDateString()}</span>
              </div>
            </div>
          ))}
        </div>
      );
    }

    function DevotionalsView({ user, profile, isUnlocked, isAdmin }) {
      const [devs, setDevs] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [title, setTitle] = useState('');
      const [content, setContent] = useState('');
      const [sysMsg, setSysMsg] = useState('');

      useEffect(() => { 
          if(!db) return;
          const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('devotionals').onSnapshot(s => setDevs(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>b.at-a.at)), err => console.log(err)); return ()=>unsub(); 
      }, []);

      const handleToggle = () => {
          if (!profile || !isUnlocked) {
              setSysMsg("‚ö†Ô∏è Acci√≥n bloqueada: Ingrese a 'Perfil' con su PIN para publicar.");
              setTimeout(() => setSysMsg(''), 5000);
          } else {
              setShowForm(!showForm);
          }
      };

      const handleAdd = async () => {
          if(!title.trim() || !content.trim() || !user || !profile) return;
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('devotionals').add({
              title, content, uid: user.uid, authorName: profile.name, at: Date.now()
          });
          setShowForm(false); setTitle(''); setContent('');
      };

      return (
        <div className="space-y-6 pb-24 max-w-[650px] mx-auto px-4 mt-4 animate-in">
          <div className="card-fb p-6 bg-gradient-to-br from-[#1877F2]/10 to-white border-t-4 border-[#1877F2] shadow-xl text-center">
            <i className="fa-solid fa-book-bible text-3xl text-[#1877F2] mb-3"></i>
            <h2 className="font-black text-xl text-gray-800 uppercase tracking-tighter italic">Pr√©dica Diaria</h2>
          </div>

          {sysMsg && <div className="bg-red-50 text-red-600 p-4 rounded-xl text-center text-[11px] font-black shadow-inner border border-red-100 mb-4">{sysMsg}</div>}

          <div className="mb-4">
             <button onClick={handleToggle} className="w-full bg-white border-2 border-[#1877F2] text-[#1877F2] font-black py-4 rounded-xl shadow-sm uppercase text-[12px] active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i className={`fa-solid ${showForm ? 'fa-xmark text-red-500' : 'fa-plus'}`}></i> {showForm ? 'Cancelar' : 'A√±adir Pr√©dica'}
             </button>
             {showForm && (
                <div className="mt-3 card-fb p-5 animate-in shadow-lg border border-gray-200">
                   <input placeholder="T√≠tulo de la Pr√©dica..." value={title} onChange={e=>setTitle(e.target.value)} className="w-full bg-gray-50 border border-gray-200 p-4 rounded-xl mb-3 outline-none font-bold text-gray-800 text-[16px]" />
                   <textarea placeholder="Escriba la ense√±anza..." value={content} onChange={e=>setContent(e.target.value)} className="w-full bg-gray-50 border border-gray-200 p-4 rounded-xl mb-4 outline-none h-40 resize-none text-gray-800 text-[16px]" />
                   <button onClick={handleAdd} className="w-full bg-[#1877F2] text-white font-black py-4 rounded-xl shadow-md uppercase text-[12px] active:scale-95 transition-transform">Publicar Pr√©dica</button>
                </div>
             )}
          </div>

          {devs.length === 0 && (
             <div className="text-center p-10 opacity-40">
                 <i className="fa-solid fa-scroll text-5xl mb-4 text-gray-400"></i>
                <p className="font-black uppercase tracking-widest text-xs text-gray-500">Esperando la palabra del d√≠a.</p>
             </div>
          )}
          {devs.map(d => (
            <div key={d.id} className="card-fb p-6 bg-white border border-gray-200 shadow-md animate-up text-left relative">
              {(isAdmin || d.uid === user?.uid) && <button onClick={()=>db.collection('artifacts').doc(appId).collection('public').doc('data').collection('devotionals').doc(d.id).delete()} className="absolute top-4 right-4 text-red-400 active:scale-90"><i className="fa-solid fa-trash-can"></i></button>}
              <h3 className="font-black text-lg text-[#1877F2] mb-1 italic uppercase">{d.title}</h3>
              <p className="text-gray-700 text-[15px] leading-relaxed mb-4 whitespace-pre-wrap">{d.content}</p>
              <div className="flex justify-between items-center border-t border-gray-100 pt-3">
                 <span className="text-[10px] text-gray-500 font-bold uppercase"><i className="fa-solid fa-user text-[#1877F2] mr-1"></i> {d.authorName}</span>
                 <span className="text-[9px] text-gray-400 font-bold uppercase italic text-right">{new Date(d.at).toLocaleDateString()}</span>
              </div>
            </div>
          ))}
        </div>
      );
    }

    function GroupView({ user, profile, isUnlocked, isAdmin }) {
      const [groups, setGroups] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [name, setName] = useState('');
      const [desc, setDesc] = useState('');
      const [sysMsg, setSysMsg] = useState('');

      useEffect(() => { 
          if(!user || !db) return; 
          const colG = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups');
          const unsub = colG.onSnapshot(s => setGroups(s.docs.map(d=>({id:d.id, ...d.data()}))), err => console.log(err)); 
          return ()=>unsub(); 
      }, [user]);

      const handleToggle = () => {
          if (!profile || !isUnlocked) {
              setSysMsg("‚ö†Ô∏è Acci√≥n bloqueada: Ingrese a 'Perfil' con su PIN para crear.");
              setTimeout(() => setSysMsg(''), 5000);
          } else {
              setShowForm(!showForm);
          }
      };

      const handleAdd = async () => {
          if(!name.trim() || !desc.trim() || !user || !profile) return;
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').add({
              name, desc, uid: user.uid, authorName: profile.name, at: Date.now()
          });
          setShowForm(false); setName(''); setDesc('');
      };

      return (
        <div className="space-y-6 pb-24 max-w-[850px] mx-auto animate-in px-4 mt-4">
          <div className="card-fb p-5 bg-white border-t-4 border-blue-500 shadow-lg text-center">
             <i className="fa-solid fa-users-rectangle text-3xl text-blue-500 mb-2"></i>
             <h2 className="font-black text-lg text-gray-800 uppercase italic">Grupos B√≠blicos</h2>
          </div>

          {sysMsg && <div className="bg-red-50 text-red-600 p-4 rounded-xl text-center text-[11px] font-black shadow-inner border border-red-100 mb-4">{sysMsg}</div>}

          <div className="mb-4">
             <button onClick={handleToggle} className="w-full bg-white border-2 border-blue-500 text-blue-600 font-black py-4 rounded-xl shadow-sm uppercase text-[12px] active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i className={`fa-solid ${showForm ? 'fa-xmark text-red-500' : 'fa-plus'}`}></i> {showForm ? 'Cancelar' : 'Crear Grupo'}
             </button>
             {showForm && (
                <div className="mt-3 card-fb p-5 animate-in shadow-lg border border-gray-200">
                   <input placeholder="Nombre del Grupo..." value={name} onChange={e=>setName(e.target.value)} className="w-full bg-gray-50 border border-gray-200 p-4 rounded-xl mb-3 outline-none font-bold text-gray-800 text-[16px]" />
                   <textarea placeholder="Descripci√≥n o Enlace de WhatsApp..." value={desc} onChange={e=>setDesc(e.target.value)} className="w-full bg-gray-50 border border-gray-200 p-4 rounded-xl mb-4 outline-none h-24 resize-none text-gray-800 text-[16px]" />
                   <button onClick={handleAdd} className="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-md uppercase text-[12px] active:scale-95 transition-transform">Crear Grupo</button>
                </div>
             )}
          </div>

          {groups.length === 0 && (
             <div className="text-center p-10 opacity-40">
                <i className="fa-solid fa-users-slash text-5xl mb-4 text-gray-400"></i>
                <p className="font-black uppercase tracking-widest text-xs text-gray-500">A√∫n no hay grupos formados.</p>
             </div>
          )}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {groups.map(g => (
              <div key={g.id} className="card-fb p-6 bg-white border border-gray-200 shadow-sm flex flex-col text-left relative">
                {(isAdmin || g.uid === user?.uid) && <button onClick={()=>db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(g.id).delete()} className="absolute top-4 right-4 text-red-400 active:scale-90"><i className="fa-solid fa-trash-can"></i></button>}
                <h3 className="font-black text-lg text-blue-600 mb-2 uppercase tracking-tighter pr-6">#{g.name}</h3>
                <p className="text-gray-600 text-[15px] mt-1 whitespace-pre-wrap">{g.desc}</p>
                <div className="mt-4 pt-3 border-t border-gray-100 text-[10px] text-gray-400 font-bold uppercase"><i className="fa-solid fa-crown text-[#D4AF37] mr-1"></i> Creado por: {g.authorName}</div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function StoreView({ isAdmin, user, profile, isUnlocked }) {
      const [items, setItems] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [name, setName] = useState('');
      const [price, setPrice] = useState('');
      const [img, setImg] = useState('');
      const [sysMsg, setSysMsg] = useState('');

      useEffect(() => { 
          if(!user || !db) return; 
          const colS = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('store');
          const unsub = colS.onSnapshot(s => setItems(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>b.at-a.at)), err => console.log(err)); 
          return ()=>unsub(); 
      }, [user]);

      const handleToggle = () => {
          if (!profile || !isUnlocked) {
              setSysMsg("‚ö†Ô∏è Acci√≥n bloqueada: Ingrese a 'Perfil' con su PIN para vender.");
              setTimeout(() => setSysMsg(''), 5000);
          } else {
              setShowForm(!showForm);
          }
      };

      const handleAdd = async () => {
          if(!name.trim() || !price.trim() || !img || !user || !profile) return;
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('store').add({
              name, price, img, uid: user.uid, authorName: profile.name, at: Date.now()
          });
          setShowForm(false); setName(''); setPrice(''); setImg('');
      };

      return (
        <div className="space-y-6 pb-24 max-w-[1050px] mx-auto px-4 mt-4 animate-in">
          <div className="card-fb p-5 bg-white border-t-4 border-green-500 shadow-lg text-center">
             <i className="fa-solid fa-store text-3xl text-green-500 mb-2"></i>
             <h2 className="font-black text-lg text-gray-800 uppercase italic">Tienda Davar</h2>
          </div>

          {sysMsg && <div className="bg-red-50 text-red-600 p-4 rounded-xl text-center text-[11px] font-black shadow-inner border border-red-100 mb-4 max-w-[650px] mx-auto">{sysMsg}</div>}

          <div className="mb-4 max-w-[650px] mx-auto">
             <button onClick={handleToggle} className="w-full bg-white border-2 border-green-500 text-green-600 font-black py-4 rounded-xl shadow-sm uppercase text-[12px] active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i className={`fa-solid ${showForm ? 'fa-xmark text-red-500' : 'fa-plus'}`}></i> {showForm ? 'Cancelar' : 'Agregar Producto'}
             </button>
             {showForm && (
                <div className="mt-3 card-fb p-5 animate-in shadow-lg border border-gray-200 flex flex-col gap-4">
                   <label className="bg-gray-50 hover:bg-gray-100 transition-colors p-6 rounded-2xl text-center cursor-pointer border-2 border-dashed border-gray-300">
                      <i className={`fa-solid ${img ? 'fa-check-circle text-green-500' : 'fa-camera text-gray-400'} text-4xl mb-2 block`}></i>
                      <span className="text-[14px] font-bold text-gray-600">{img ? 'Imagen Lista' : 'Subir Foto del Producto'}</span>
                      <input type="file" className="hidden" accept="image/*" onChange={async e=>setImg(await compressMedia(e.target.files[0]))} />
                   </label>
                   {img && <img src={img} className="h-32 object-contain rounded-xl shadow-md border border-gray-200" />}
                   <input placeholder="Nombre del Producto..." value={name} onChange={e=>setName(e.target.value)} className="w-full bg-gray-50 border border-gray-200 p-4 rounded-xl outline-none font-bold text-gray-800 text-[16px]" />
                   <input type="number" placeholder="Precio (Ej: 10000)" value={price} onChange={e=>setPrice(e.target.value)} className="w-full bg-gray-50 border border-gray-200 p-4 rounded-xl outline-none font-bold text-gray-800 text-[16px]" />
                   <button onClick={handleAdd} className="w-full bg-green-500 text-white font-black py-4 rounded-xl shadow-md uppercase text-[12px] active:scale-95 transition-transform">Publicar en Tienda</button>
                </div>
             )}
          </div>

          {items.length === 0 && (
             <div className="text-center p-10 opacity-40">
                <i className="fa-solid fa-store-slash text-5xl mb-4 text-gray-400"></i>
                <p className="font-black uppercase tracking-widest text-xs text-gray-500">La tienda ministerial est√° vac√≠a.</p>
             </div>
          )}
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {items.map(i => (
              <div key={i.id} className="store-item bg-white rounded-2xl flex flex-col border border-gray-200 shadow-sm overflow-hidden relative active:scale-95 transition-transform text-left">
                {(i.uid === user?.uid || isAdmin) && <button onClick={async ()=>{ const colS = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('store'); await colS.doc(i.id).delete(); }} className="absolute top-2 right-2 text-red-500 bg-white p-1 rounded-full shadow-md"><i className="fa-solid fa-trash-can text-xs"></i></button>}
                <img src={i.img} className="h-36 w-full object-cover" onError={(e)=>{e.target.src=LOGO_URL}} />
                <div className="p-3 flex-1 flex flex-col">
                  <p className="text-green-700 font-black text-lg mb-1 italic font-serif">${i.price}</p>
                  <h4 className="font-bold text-gray-800 truncate text-[12px] mb-2 uppercase">{i.name}</h4>
                  <button onClick={()=>window.open(`https://api.whatsapp.com/send?text=Bendiciones, me interesa tu producto en Davar: ${i.name}`,'_blank')} className="w-full mt-auto bg-gray-100 py-2.5 rounded-lg font-black text-[9px] uppercase border border-gray-200 shadow-sm text-gray-800">WhatsApp</button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function ProfilePosts({ user }) {
      const [myPosts, setMyPosts] = useState([]);
      useEffect(() => { 
          if (!user || !db) return; 
          const colP = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts');
          const unsub = colP.onSnapshot(s => setMyPosts(s.docs.map(d=>({id:d.id, ...d.data()})).filter(x=> user && x.uid === user.uid).sort((a,b)=>b.at-a.at)), err => console.log(err)); 
          return () => unsub(); 
      }, [user?.uid]);
      return (
        <div className="max-w-[620px] mx-auto space-y-4 mt-6 px-2 md:px-0">
          <h3 className="font-black text-xs uppercase tracking-widest text-gray-400 text-center italic mb-3">Mi Historial Ministerial</h3>
          {myPosts.length === 0 && <p className="text-[10px] text-gray-400 uppercase font-bold opacity-50">A√∫n no has compartido nada en el muro.</p>}
          {myPosts.map(p => (
            <div key={p.id} className="card-fb bg-white p-4 shadow-sm border border-gray-200 flex justify-between items-start animate-up text-left">
               <div className="flex-1 text-left pr-3"><p className="text-[9px] text-[#1877F2] font-black mb-1 uppercase leading-none">{new Date(p.at).toLocaleString()}</p>{p.text && <p className="text-[13px] line-clamp-2 italic text-gray-700">"{p.text}"</p>}</div>
               <button onClick={async ()=>{ const colP = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts'); await colP.doc(p.id).delete(); }} className="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center shadow-sm flex-shrink-0 active:scale-90 transition-transform"><i className="fa-solid fa-trash-can text-sm"></i></button>
            </div>
          ))}
        </div>
      );
    }

    function App() {
      const [user, setUser] = useState(null); const [profile, setProfile] = useState(null);
      const [tab, setTab] = useState('feed'); 
      const [isUnlocked, setUnlocked] = useState(localStorage.getItem('davar_unlocked') === 'true');
      const [pinIn, setPinIn] = useState(''); const [isBroadcasting, setIsBroadcasting] = useState(false); const [liveId, setLiveId] = useState(null);
      const [isAdmin, setIsAdmin] = useState(localStorage.getItem('davar_admin') === 'true');
      const [regName, setRegName] = useState(''); const [regPin, setRegPin] = useState('');
      const [regPhone, setRegPhone] = useState(''); const [regEmail, setRegEmail] = useState('');
      const [loadingAuth, setLoadingAuth] = useState(false); 
      const [authError, setAuthError] = useState('');
      const [showAdminModal, setShowAdminModal] = useState(false); const [adminPwd, setAdminPwd] = useState('');
      
      const [deferredPrompt, setDeferredPrompt] = useState(null);
      const [showInstallModal, setShowInstallModal] = useState(false);

      if (typeof isInvalidKey !== 'undefined' && isInvalidKey) {
          return (
              <div className="h-screen bg-[#F0F2F5] flex flex-col items-center justify-center p-6 text-center">
                  <i className="fa-solid fa-triangle-exclamation text-5xl text-red-500 mb-4"></i>
                  <h2 className="font-black text-xl text-gray-800 uppercase mb-2">Conexi√≥n Incompleta</h2>
                  <p className="text-gray-600 text-sm">El Arca no pudo encontrar la configuraci√≥n de la base de datos (Firebase).</p>
              </div>
          );
      }

      useEffect(() => {
        const manifest = {
          name: "Comunidad Davar",
          short_name: "Davar",
          start_url: window.location.href,
          display: "standalone",
          background_color: "#F0F2F5",
          theme_color: "#1877F2",
          icons: [{
            src: "data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%231877F2%22%20rx%3D%2240%22%2F%3E%3Ctext%20x%3D%22100%22%20y%3D%22115%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-weight%3D%22900%22%20font-size%3D%2285%22%20fill%3D%22white%22%20text-anchor%3D%22middle%22%20letter-spacing%3D%22-4%22%3ECD%3C%2Ftext%3E%3Ctext%20x%3D%22100%22%20y%3D%22160%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-weight%3D%22900%22%20font-size%3D%2226%22%20fill%3D%22%23D4AF37%22%20text-anchor%3D%22middle%22%20text-transform%3D%22uppercase%22%20letter-spacing%3D%222%22%3EDios%3C%2Ftext%3E%3C%2Fsvg%3E",
            sizes: "512x512",
            type: "image/svg+xml",
            purpose: "any maskable"
          }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        let link = document.querySelector('link[rel="manifest"]');
        if (!link) { link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
        link.href = manifestURL;

        const handleBeforeInstallPrompt = (e) => { e.preventDefault(); setDeferredPrompt(e); };
        window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
        
        const swCode = `self.addEventListener('install', (e) => self.skipWaiting()); self.addEventListener('activate', (e) => self.clients.claim()); self.addEventListener('fetch', (e) => {});`;
        const swBlob = new Blob([swCode], {type: 'application/javascript'});
        if ('serviceWorker' in navigator) navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(()=>{});

        return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
      }, []);

      const handleInstallClick = () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(() => setDeferredPrompt(null));
        } else {
          setShowInstallModal(true);
        }
      };

      useEffect(() => {
        let unsub = null;
        const initAuth = async () => {
          try { await auth.signInAnonymously(); } catch(e) { setLoadingAuth(false); }
        };
        initAuth();

        const unsubAuth = auth.onAuthStateChanged((cur) => {
          if (cur) {
             setUser(cur);
             unsub = db.collection('artifacts').doc(appId).collection('users').doc(cur.uid).collection('profile').doc('data').onSnapshot(pDoc => {
                if(pDoc.exists) { 
                    setProfile(pDoc.data()); 
                    if(localStorage.getItem('davar_unlocked') === 'true') { setUnlocked(true); }
                } else { setProfile(null); }
                setLoadingAuth(false);
             }, err => { 
                setAuthError("Verifique la seguridad de su servidor.");
                setLoadingAuth(false); 
             });
          } else { 
             setLoadingAuth(false); 
          }
        });
        return () => { unsubAuth(); if (unsub) unsub(); };
      }, []);

      const handleRegister = async (e) => {
        e.preventDefault(); 
        setAuthError('');

        if (!regName.trim() || !regPin.trim()) {
            setAuthError("‚ö†Ô∏è Llene su nombre y PIN, por favor."); 
            return; 
        }
        
        setLoadingAuth(true); 

        try {
            let activeUser = user;
            if (!activeUser) { 
                const cred = await auth.signInAnonymously();
                activeUser = cred.user;
                setUser(activeUser);
            }
            
            const p={uid:activeUser.uid, name:regName.trim(), phone:regPhone.trim(), email:regEmail.trim(), pin:regPin.trim(), photo:LOGO_URL, cover:DEFAULT_COVER, at:Date.now()};
            await db.collection('artifacts').doc(appId).collection('users').doc(activeUser.uid).collection('profile').doc('data').set(p);
            
            setProfile(p); 
            setUnlocked(true); 
            localStorage.setItem('davar_unlocked', 'true');
            setLoadingAuth(false);
        } catch(err) { 
            setLoadingAuth(false);
            console.error(err);
            if(err.code === 'auth/operation-not-allowed') {
                setAuthError("‚ö†Ô∏è Falta habilitar el acceso 'An√≥nimo' en Firebase.");
            } else if (err.code === 'permission-denied') {
                setAuthError("‚ö†Ô∏è Error de permisos en la ruta privada.");
            } else {
                setAuthError("‚ö†Ô∏è Error del servidor: " + err.message); 
            }
        }
      };

      const handleLogin = (e) => {
        e.preventDefault();
        setAuthError('');
        if(pinIn === profile.pin) { setUnlocked(true); localStorage.setItem('davar_unlocked','true'); } 
        else { setAuthError("‚ö†Ô∏è El PIN ingresado es incorrecto."); }
      };

      if (loadingAuth) return <div className="h-screen bg-[#F0F2F5] flex flex-col items-center justify-center animate-in"><img src={LOGO_URL} className="w-20 h-20 rounded-full mb-6 shadow-2xl animate-pulse bg-white border-4 border-[#1877F2]" /><p className="text-[#1877F2] font-black uppercase tracking-widest italic animate-pulse text-[10px]">Conectando al Aposento...</p></div>;
      
      return (
        <div className="h-screen flex flex-col overflow-hidden bg-[#F0F2F5]">
          {(!profile || !isUnlocked) && <GuestBanner />}
          
          <header className="header-fb sticky top-0 z-40">
            <div onClick={()=>setTab('feed')} className="flex items-center gap-2 cursor-pointer transition-transform flex-shrink-0">
               <img onClick={(e) => { e.stopPropagation(); setShowAdminModal(true); }} src={LOGO_URL} className="w-9 h-9 rounded-full shadow-md cursor-pointer active:scale-90 border border-gray-200" />
               <span className="font-black text-[#1877F2] uppercase tracking-tighter italic text-[16px] ml-1 leading-none drop-shadow-sm">Comunidad Davar {isAdmin && <span className="text-red-500 text-[8px] block">(Admin)</span>}</span>
            </div>
            
            <div className="flex items-center">
                <button onClick={handleInstallClick} className="bg-blue-50 text-[#1877F2] px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest shadow-sm border border-blue-100 flex items-center gap-2 active:scale-95 transition-transform">
                    <i className="fa-solid fa-download"></i> <span className="hidden sm:inline">Instalar</span>
                </button>
            </div>
          </header>

          {showInstallModal && (
            <div className="fixed inset-0 bg-black/80 z-[6000] flex items-center justify-center p-4 animate-in">
                <div className="bg-white p-6 rounded-3xl w-full max-w-sm text-center shadow-2xl relative border-t-4 border-[#1877F2]">
                    <button onClick={() => setShowInstallModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-800 active:scale-90"><i className="fa-solid fa-xmark text-2xl"></i></button>
                    
                    <img src={LOGO_URL} className="w-20 h-20 rounded-full mx-auto mb-4 shadow-md border-2 border-gray-100 bg-white" />
                    <h3 className="text-[#1877F2] font-black text-xl uppercase tracking-tighter mb-2">Instalar Aplicaci√≥n</h3>
                    <p className="text-gray-600 text-sm mb-6 leading-relaxed">Para tener la Red Davar en su pantalla de inicio y usarla sin entrar al navegador, siga estos pasos:</p>
                    
                    <div className="bg-gray-50 p-5 rounded-2xl text-left text-sm text-gray-700 space-y-4 mb-6 border border-gray-200 shadow-inner">
                        <p className="flex items-start gap-3">
                            <span className="text-2xl">üçè</span> 
                            <span><b>En iPhone (Safari):</b> Toque el √≠cono de Compartir <i className="fa-solid fa-arrow-up-from-bracket text-blue-500 mx-1"></i> en la barra inferior y luego seleccione <b>"Agregar a Inicio"</b>.</span>
                        </p>
                        <div className="h-px bg-gray-200 w-full"></div>
                        <p className="flex items-start gap-3">
                            <span className="text-2xl">ü§ñ</span> 
                            <span><b>En Android (Chrome):</b> Toque los 3 puntos <i className="fa-solid fa-ellipsis-vertical text-gray-800 mx-1"></i> arriba a la derecha y elija <b>"Agregar a la pantalla principal"</b> o <b>"Instalar aplicaci√≥n"</b>.</span>
                        </p>
                    </div>
                    
                    <button onClick={() => setShowInstallModal(false)} className="w-full bg-[#1877F2] text-white font-black py-4 rounded-xl shadow-md uppercase text-[12px] tracking-widest active:scale-95 transition-all">
                        ¬°Entendido!
                    </button>
                </div>
            </div>
          )}

          {showAdminModal && (
            <div className="fixed inset-0 bg-black/80 z-[6000] flex items-center justify-center p-4 animate-in">
                <div className="bg-white p-6 rounded-2xl w-full max-w-sm border-t-4 border-[#1877F2] shadow-2xl">
                    <h3 className="text-[#1877F2] font-black mb-4 uppercase tracking-widest text-center text-sm">Jerarqu√≠a Mayor</h3>
                    <input type="password" value={adminPwd} onChange={e=>setAdminPwd(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl text-gray-800 outline-none mb-6 text-center tracking-widest font-bold border border-gray-200 text-[16px]" placeholder="Clave..." />
                    <div className="flex gap-3">
                        <button onClick={()=>setShowAdminModal(false)} className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-xs uppercase active:scale-95">Cancelar</button>
                        <button onClick={()=>{ if(adminPwd==="davar2026"){setIsAdmin(true); localStorage.setItem('davar_admin','true'); setShowAdminModal(false);} else { setAdminPwd(''); } }} className="flex-1 bg-[#1877F2] text-white py-3 rounded-xl font-black text-xs uppercase shadow-lg active:scale-95">Confirmar</button>
                    </div>
                </div>
            </div>
          )}

          <main id="main-scroller" className="flex-1 overflow-y-auto custom-scrollbar pb-24 scroll-smooth w-full">
             <div className={`w-full max-w-[650px] mx-auto transition-all`}>
                {tab==='feed' && <WallView user={user} profile={profile} isUnlocked={isUnlocked} isAdmin={isAdmin} onStartLive={()=>setIsBroadcasting(true)} onJoinLive={id=>setLiveId(id)} />}
                {tab==='chat' && <ChatPanel user={user} profile={profile} isUnlocked={isUnlocked} isAdmin={isAdmin} />}
                {tab==='wisdom' && <WisdomView user={user} profile={profile} isUnlocked={isUnlocked} isAdmin={isAdmin} />}
                {tab==='groups' && <GroupView user={user} profile={profile} isUnlocked={isUnlocked} isAdmin={isAdmin} />}
                {tab==='store' && <StoreView user={user} profile={profile} isUnlocked={isUnlocked} isAdmin={isAdmin} />}
                {tab==='devs' && <DevotionalsView user={user} profile={profile} isUnlocked={isUnlocked} isAdmin={isAdmin} />}
                {tab==='profile' && (
                    (!profile || !isUnlocked) ? (
                        <div className="card-fb p-8 max-w-sm mx-auto mt-6 text-center border-t-4 border-[#1877F2] shadow-2xl bg-white animate-up m-2 sm:m-auto">
                            {!profile ? (
                                <>
                                    <h3 className="mb-3 font-black text-gray-800 uppercase tracking-widest text-lg text-center leading-none">√önete a la Familia</h3>
                                    <form onSubmit={handleRegister} className="space-y-3 text-left">
                                        <div><label className="text-[10px] font-black uppercase text-gray-400 ml-2">Nombre Ministerial</label><input type="text" value={regName} onChange={e=>setRegName(e.target.value)} className="input-pill bg-gray-50 border border-gray-200 shadow-inner mt-1 h-12 text-[16px] font-bold w-full outline-none px-4 text-gray-800" required /></div>
                                        <div><label className="text-[10px] font-black uppercase text-gray-400 ml-2">Tel√©fono (Para recuperar PIN)</label><input type="tel" value={regPhone} onChange={e=>setRegPhone(e.target.value)} className="input-pill bg-gray-50 border border-gray-200 shadow-inner mt-1 h-12 text-[16px] font-bold w-full outline-none px-4 text-gray-800" required /></div>
                                        <div><label className="text-[10px] font-black uppercase text-gray-400 ml-2">Correo (Opcional)</label><input type="email" value={regEmail} onChange={e=>setRegEmail(e.target.value)} className="input-pill bg-gray-50 border border-gray-200 shadow-inner mt-1 h-12 text-[16px] font-bold w-full outline-none px-4 text-gray-800" /></div>
                                        <div><label className="text-[10px] font-black uppercase text-gray-400 ml-2">Crear PIN (N√∫meros)</label><input type="password" value={regPin} onChange={e=>setRegPin(e.target.value)} className="input-pill bg-gray-50 border border-gray-200 text-center text-xl font-black tracking-[0.5em] shadow-inner mt-1 h-12 w-full outline-none text-gray-800" required /></div>
                                        {authError && <div className="bg-red-50 text-red-500 p-2 rounded-lg text-[10px] font-bold text-center animate-pulse border border-red-200">{authError}</div>}
                                        <button type="submit" className="w-full bg-[#1877F2] text-white font-black py-4 rounded-xl shadow-lg active:scale-95 uppercase text-[11px] tracking-widest mt-4 transition-transform">Ingresar Perfil</button>
                                    </form>
                                </>
                            ) : (
                                <>
                                    <img src={profile.photo} onError={(e)=>{e.target.src=LOGO_URL}} className="w-24 h-24 mx-auto mb-4 rounded-full border-4 border-[#1877F2] object-cover shadow-xl bg-white" />
                                    <h2 className="font-black text-gray-800 uppercase tracking-widest mb-1 text-xl leading-none">{profile.name}</h2>
                                    <p className="text-gray-500 text-[10px] uppercase font-black mb-6 italic opacity-60 text-center tracking-widest leading-none">Sello Ministerial (PIN)</p>
                                    <form onSubmit={handleLogin} className="space-y-4">
                                        <input type="password" placeholder="PIN" value={pinIn} onChange={e=>setPinIn(e.target.value)} className="input-pill bg-gray-50 border border-gray-200 text-center text-3xl font-black tracking-[0.5em] outline-none shadow-inner h-16 w-full text-gray-800" required autoFocus />
                                        {authError && <div className="bg-red-50 text-red-500 p-2 rounded-lg text-xs font-bold animate-pulse border border-red-200">{authError}</div>}
                                        <button type="submit" className="w-full bg-[#1877F2] text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-all uppercase tracking-widest h-14 text-[13px]">Entrar</button>
                                    </form>
                                </>
                            )}
                        </div>
                    ) : (
                        <div className="space-y-4 pb-10 text-center mt-2 mx-2 sm:mx-0">
                          <div className="card-social overflow-hidden animate-in shadow-xl bg-white border-t-4 border-[#1877F2] pb-6">
                            <div className="relative h-40 bg-gray-200 shadow-inner">
                              <img src={profile.cover || DEFAULT_COVER} className="h-full w-full object-cover" />
                              <button onClick={()=>{const i=document.createElement('input');i.type='file';i.accept='image/*';i.onchange=async(e)=>{const r=await compressMedia(e.target.files[0]); await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('data').update({cover:r});};i.click();}} className="absolute bottom-2 right-2 bg-black/50 p-2 rounded-lg text-white shadow-lg active:scale-110 transition-transform"><i className="fa-solid fa-camera"></i></button>
                            </div>
                            <div className="p-4 pt-0 flex flex-col items-center">
                              <div className="mt-[-50px] relative inline-block">
                                <img src={profile.photo || LOGO_URL} onError={(e)=>{e.target.src=LOGO_URL}} className="w-28 h-28 rounded-full object-cover border-4 border-white shadow-inner bg-white" />
                                <button onClick={()=>{const i=document.createElement('input');i.type='file';i.accept='image/*';i.onchange=async(e)=>{const r=await compressMedia(e.target.files[0]); await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('data').update({photo:r});};i.click();}} className="absolute bottom-1 right-1 bg-[#1877F2] p-2.5 rounded-full text-white shadow-lg active:scale-125 transition-transform"><i className="fa-solid fa-camera text-xs"></i></button>
                              </div>
                              <h2 className="font-black text-2xl mt-4 text-gray-900 tracking-tight uppercase italic leading-none">{profile.name}</h2>
                              <p className="text-[11px] text-gray-500 mt-1 font-black tracking-widest uppercase italic leading-none">Siervo Davar</p>
                              
                              <div className="w-full max-w-[280px] mt-6 flex gap-2">
                                 <button onClick={()=>setTab('feed')} className="flex-1 bg-gray-100 text-gray-600 font-black py-3 rounded-xl shadow-sm uppercase text-[10px] tracking-widest active:scale-95 transition-all">Muro</button>
                                 <button onClick={()=>{localStorage.removeItem('davar_unlocked'); setUnlocked(false);}} className="flex-1 bg-red-50 text-red-500 font-black py-3 rounded-xl shadow-sm uppercase text-[10px] tracking-widest active:scale-95 transition-all">Cerrar Perfil</button>
                              </div>
                              
                              <button onClick={()=>{localStorage.clear(); window.location.reload();}} className="w-full max-w-[280px] mt-2 bg-gray-800 text-white font-black py-3 rounded-xl shadow-md uppercase text-[10px] tracking-widest active:scale-95 transition-all">
                                  Salir de la Red Completamente
                              </button>
                            </div>
                          </div>
                          <ProfilePosts user={user} />
                        </div>
                    )
                )}
             </div>
          </main>

          <nav className="nav-bottom">
             <button onClick={()=>setTab('feed')} className={`nav-btn ${tab==='feed'?'active':''}`}><i className="fa-solid fa-house"></i><span>Inicio</span></button>
             <button onClick={()=>setTab('chat')} className={`nav-btn ${tab==='chat'?'active':''}`}><i className="fa-solid fa-comments"></i><span>Chat</span></button>
             <button onClick={()=>setTab('wisdom')} className={`nav-btn ${tab==='wisdom'?'active':''}`}><i className="fa-solid fa-sparkles"></i><span>Sabidur√≠a</span></button>
             <button onClick={()=>setTab('groups')} className={`nav-btn ${tab==='groups'?'active':''}`}><i className="fa-solid fa-users-rectangle"></i><span>Grupos</span></button>
             <button onClick={()=>setTab('store')} className={`nav-btn ${tab==='store'?'active':''}`}><i className="fa-solid fa-store"></i><span>Tienda</span></button>
             <button onClick={()=>setTab('devs')} className={`nav-btn ${tab==='devs'?'active':''}`}><i className="fa-solid fa-book-open"></i><span>Pr√©dica</span></button>
             <button onClick={()=>setTab('profile')} className={`nav-btn ${tab==='profile'?'active':''}`}><i className="fa-solid fa-circle-user"></i><span>Perfil</span></button>
          </nav>
          
          {isBroadcasting && user?.uid && <LiveSession profile={profile} broadcasterId={user.uid} isBroadcaster={true} onClose={()=>setIsBroadcasting(false)} />}
          {liveId && <LiveSession profile={profile} broadcasterId={liveId} isBroadcaster={false} onClose={()=>setLiveId(null)} />}
        </div>
      );
    }

    const domNode = document.getElementById('root');
    const rootInstance = ReactDOM.createRoot(domNode);
    rootInstance.render(<App />);
  </script>
</body>
</html>
